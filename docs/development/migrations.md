# Database Migrations (Alembic)

This project uses Alembic (SQLAlchemy migrations) to manage database schema changes for the FastAPI backend.

## Configuration

- Alembic config: [`alembic.ini`](alembic.ini)
- Alembic environment: [`alembic/env.py`](alembic/env.py)
- Custom script template (optional): [`alembic/script.py.mako`](alembic/script.py.mako)
- Versions directory: [`alembic/versions/`](alembic/versions/)
- Initial baseline: [`0001_initial_baseline`](alembic/versions/0001_initial_baseline.py)

Target metadata is sourced from the backend models:
- [`Base`](fba_bench_api/core/database.py:11) is imported by Alembic to expose `Base.metadata` for autogeneration.

## Environment

Alembic reads the database URL from the `DATABASE_URL` environment variable with a sensible default:
- Default development: `sqlite:///./fba_bench.db`
- Example production: `postgresql+psycopg://user:password@localhost:5432/fba_bench`

See examples in [`env file`](.env.example:1).

## Installation

Ensure dependencies are installed (includes Alembic and SQLAlchemy):

```bash
poetry install --with dev
```

## Common Tasks

- Create a new migration from model changes:
  ```bash
  alembic revision --autogenerate -m "describe change"
  ```

- Apply all pending migrations:
  ```bash
  alembic upgrade head
  ```

- Show current head(s):
  ```bash
  alembic heads
  ```

- Downgrade one step (use with caution):
  ```bash
  alembic downgrade -1
  ```

- Re-apply last migration (useful during development):
  ```bash
  alembic downgrade -1 && alembic upgrade head
  ```

## Programmatic Runner (Optional)

You can trigger an upgrade via a helper script:
- [`db_migrate.py`](scripts/db_migrate.py:1)

```bash
poetry run python scripts/db_migrate.py
```

## CI and Local Development

- Local dev default is SQLite file `./fba_bench.db` if `DATABASE_URL` is not set.
- For CI/integration tests, see:
  - [`test_alembic_migrations.py`](tests/integration/test_alembic_migrations.py:1)
  This test exercises `upgrade head`, `downgrade base`, and `upgrade head` against a temporary SQLite database.

## Autogeneration Notes

Alembic is configured to autogenerate from `Base.metadata`:
- `compare_type=True` to detect column type changes
- `compare_server_default=True` to detect default changes

Keep migrations deterministic:
- Avoid conditional Python logic in migration scripts affecting schema
- Provide clear `upgrade()` and `downgrade()` logic in autogenerated files